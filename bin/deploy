#!/bin/bash

# GCP project name
PROJECT=$(gcloud config get-value project)
SERVICE_NAME=pubsub-to-bigquery-pump

gcloud beta run deploy $SERVICE_NAME \
	--no-allow-unauthenticated \
	--image gcr.io/cloudylabs-public/pubsub-to-bigquery-pump:0.1.1 \
	--platform managed \
	--timeout 15m \
	--region us-central1 \
	--set-env-vars "RELEASE=v0.1.1" \
	--service-account pump-service@${PROJECT}.iam.gserviceaccount.com


gcloud beta run services add-iam-policy-binding $SERVICE_NAME \
    --member "serviceAccount:pump-service@${PROJECT}.iam.gserviceaccount.com" \
    --role roles/run.invoker